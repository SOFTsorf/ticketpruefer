<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DFI Koblenz Zentralplatz</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght,ROND@800,100&family=Inter:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --case-bg: #4a4d52;      /* Die Farbe des grauen Kastens */
            --screen-bg: #181818;    /* Der fast schwarze Hintergrund der Anzeige */
            --led-on: #ffaa00;       /* Die Farbe der leuchtenden Punkte */
            --text-static: #d0d0d0;  /* Farbe für "Linie/Ziel/Abfahrt" */
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center; /* Zentriert vertikal */
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', sans-serif;
            padding: 10px;
        }

        /* Das Gehäuse */
        .dfi-housing {
            background-color: var(--case-bg);
            padding: 15px 20px 30px 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px; /* Breite wie eine echte Anzeige */
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            position: relative;
        }

        /* Überschrift: Zentralplatz */
        .station-header {
            color: #e0e0e0;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 15px;
            letter-spacing: 0.5px;
            padding-left: 5px;
        }

        /* Kopfzeile: Linie Ziel Abfahrt */
        .column-headers {
            display: grid;
            grid-template-columns: 1.2fr 4fr 1.5fr;
            color: var(--text-static);
            font-size: 0.95rem;
            margin-bottom: 8px;
            padding: 0 5px;
        }

        .column-headers span:last-child {
            text-align: right;
        }

        /* Der Bildschirmbereich */
        .matrix-display {
            background-color: var(--screen-bg);
            padding: 15px 10px;
            border-radius: 4px;
            box-shadow: inset 0 3px 15px rgba(0,0,0,0.7);
            min-height: 220px;
            position: relative;
            overflow: hidden;
        }

        /* Zeilen in der Matrix */
        .matrix-row {
            display: grid;
            grid-template-columns: 1.2fr 4fr 1.5fr;
            margin-bottom: 12px; /* Abstand zwischen Bussen */
            align-items: baseline;
            
            /* HIER passiert die Magie für den LED Look: */
            font-family: 'Doto', sans-serif;
            font-weight: 800;
            font-variation-settings: "ROND" 100; /* Runde Pixel */
            color: var(--led-on);
            font-size: 1.4rem; /* Schriftgröße der LEDs */
            line-height: 1.1;
            text-transform: uppercase;
            text-shadow: 0 0 5px rgba(255, 170, 0, 0.5); /* Leuchten */
        }

        .line { text-align: left; }
        
        .dest { 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            padding-right: 10px;
        }
        
        .time { 
            text-align: right; 
        }

        /* Blink-Effekt für "sofort" */
        .blink {
            animation: blinker 1.5s steps(2, start) infinite;
        }

        @keyframes blinker {
            to { visibility: hidden; }
        }

        /* Lade- / Fehlermeldungen */
        .status-msg {
            font-family: 'Doto', sans-serif;
            font-weight: 800;
            font-variation-settings: "ROND" 100;
            color: var(--led-on);
            text-align: center;
            margin-top: 60px;
            font-size: 1.2rem;
            text-transform: uppercase;
        }

        .error-msg {
            color: #ff4444; /* Rot bei Fehler */
            text-shadow: none;
        }

    </style>
</head>
<body>

    <div class="dfi-housing">
        <div class="station-header">Zentralplatz</div>
        
        <div class="column-headers">
            <span>Linie</span>
            <span>Ziel</span>
            <span>Abfahrt</span>
        </div>

        <div class="matrix-display" id="display">
            <div class="status-msg blink">Suche Verbindung...</div>
        </div>
    </div>

    <script>
        // Wir suchen zuerst dynamisch nach der Station, das ist sicherer
        const STATION_NAME = "Koblenz Zentralplatz Forum";
        let stationID = null;

        const display = document.getElementById('display');

        async function init() {
            try {
                // 1. Station ID suchen (verhindert falschen Code)
                if (!stationID) {
                    const searchResp = await fetch(`https://v6.db.transport.rest/locations?query=${encodeURIComponent(STATION_NAME)}&results=1`);
                    const searchData = await searchResp.json();
                    
                    if (searchData && searchData.length > 0) {
                        stationID = searchData[0].id;
                        console.log("Station ID gefunden:", stationID);
                    } else {
                        throw new Error("Station nicht gefunden");
                    }
                }

                updateDepartures();
                // Aktualisiere alle 30 Sekunden
                setInterval(updateDepartures, 30000);

            } catch (e) {
                showError("Verbindungsfehler");
                // Versuche es in 5 Sekunden nochmal
                setTimeout(init, 5000);
            }
        }

        async function updateDepartures() {
            if (!stationID) return;

            try {
                // 2. Abfahrten laden
                const resp = await fetch(`https://v6.db.transport.rest/stops/${stationID}/departures?results=6&duration=60`);
                if (!resp.ok) throw new Error("API Fehler");
                
                const data = await resp.json();
                renderBoard(data.departures);

            } catch (e) {
                console.error(e);
                // Wenn schon Daten da sind, nichts tun (besser alte Daten als "Fehler")
                if (display.innerHTML.includes("Suche")) {
                    showError("Keine Daten");
                }
            }
        }

        function renderBoard(departures) {
            display.innerHTML = ''; // Leeren

            if (!departures || departures.length === 0) {
                display.innerHTML = '<div class="status-msg">Kein Betrieb</div>';
                return;
            }

            const now = new Date();

            departures.forEach(dep => {
                // Zeit berechnen
                const realTime = dep.when || dep.plannedWhen;
                const dateObj = new Date(realTime);
                const diffMs = dateObj - now;
                const minutes = Math.floor(diffMs / 60000);

                // LOGIK: "sofort" oder Zeit
                let timeString = "";
                let isImmediate = false;

                if (minutes <= 1) { 
                    // Wenn weniger als 1 Minute
                    timeString = "sofort";
                    isImmediate = true;
                } else if (minutes < 20) {
                    // Bis 20 Min zeigen wir Minuten
                    timeString = minutes + " Min";
                } else {
                    // Danach Uhrzeit (HH:MM)
                    const h = dateObj.getHours().toString().padStart(2, '0');
                    const m = dateObj.getMinutes().toString().padStart(2, '0');
                    timeString = h + ":" + m;
                }

                // Linie und Ziel
                let line = dep.line.name || "?";
                let dest = dep.direction || "Unbekannt";

                // Ziel kürzen, falls extrem lang (damit es ins Layout passt)
                if (dest.length > 18) {
                    dest = dest.substring(0, 16) + ".";
                }

                // HTML bauen
                const row = document.createElement('div');
                row.className = 'matrix-row';
                
                // Falls "sofort", fügen wir eventuell eine Blink-Klasse hinzu?
                // Echte Anzeigen blinken oft bei "sofort" nicht, aber wenn du willst:
                // if (isImmediate) timeString = `<span class="">${timeString}</span>`;

                row.innerHTML = `
                    <span class="line">${line}</span>
                    <span class="dest">${dest}</span>
                    <span class="time">${timeString}</span>
                `;
                display.appendChild(row);
            });
        }

        function showError(msg) {
            display.innerHTML = `<div class="status-msg error-msg">${msg}</div>`;
        }

        // Starten
        init();
    </script>
</body>
</html>
