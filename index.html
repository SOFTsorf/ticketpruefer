<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DFI Modern Matrix</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght@300..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* MODERN DFI COLORS */
            --led-on: #ffb000;      /* Klassisches DFI Orange/Amber */
            --led-off: #2a1f00;     /* Die Farbe von "ausgeschalteten" Pixeln */
            --bg-color: #050505;    /* Gehäuse Schwarz */
            
            --pixel-size: 3px;      /* Größe eines Pixels für das Hintergrundmuster */
            
            /* Layout Spaltenbreiten */
            --col-line: 14vw; 
            --col-time: 20vw;
        }

        body, html {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--led-on);
            font-family: 'Doto', sans-serif;
            /* ROND 100 = Runde Punkte, wght 800 = Fett/Hell */
            font-variation-settings: "ROND" 100, "wght" 800;
            height: 100vh; width: 100vw;
            overflow: hidden;
            user-select: none;
        }

        /* --- MATRIX GRID EFFEKT (Hintergrund) --- */
        .matrix-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 9999;
            background-image: 
                linear-gradient(90deg, rgba(0,0,0,0.8) 10%, transparent 10%),
                linear-gradient(rgba(0,0,0,0.8) 10%, transparent 10%);
            background-size: var(--pixel-size) var(--pixel-size);
            opacity: 0.6; 
        }

        /* --- GLOW (Bloom) --- */
        #display-screen {
            text-shadow: 0 0 8px rgba(255, 176, 0, 0.5), 0 0 2px rgba(255, 176, 0, 0.8);
        }

        /* --- SETUP SCREEN --- */
        #setup-screen {
            position: fixed; inset: 0; background: #111; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Inter', sans-serif; color: white;
        }
        .input-group { margin-bottom: 20px; width: 300px; }
        .input-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .input-group input { 
            width: 100%; padding: 15px; background: #222; border: 1px solid #444;
            color: white; border-radius: 6px; font-size: 1.1rem; outline: none; transition: 0.2s;
        }
        .input-group input:focus { border-color: var(--led-on); }
        #start-btn { 
            width: 300px; padding: 15px; background: var(--led-on); border: none; 
            border-radius: 6px; font-weight: bold; cursor: pointer; color: black; 
            font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;
            transition: transform 0.1s;
        }
        #start-btn:active { transform: scale(0.98); }
        #error-msg {
            color: #ff3333; margin-top: 10px; font-size: 0.9rem; min-height: 1.2em; text-align: center;
        }

        /* --- LAMP TEST (Boot Animation) --- */
        #lamp-test {
            position: fixed; inset: 0; z-index: 9000;
            background-color: var(--led-on);
            display: none;
        }

        /* --- MAIN DISPLAY --- */
        #display-screen { 
            display: none; flex-direction: column; height: 100%; 
            box-sizing: border-box; padding: 1vh 2vw;
        }

        .header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 2px solid var(--led-on);
            padding-bottom: 0.5vh;
            margin-bottom: 0.5vh;
        }
        .station-name {
            font-size: 5vh; line-height: 1;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 80%;
            text-transform: uppercase; /* Sieht oft realistischer aus */
        }
        .clock { font-size: 5vh; line-height: 1; }

        .labels {
            display: grid; 
            grid-template-columns: var(--col-line) 1fr var(--col-time);
            font-family: 'Inter', sans-serif; 
            color: #888; 
            font-size: 2vh;
            padding-bottom: 1vh;
        }
        .labels span:last-child { text-align: right; }

        #matrix-rows { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
        
        .row {
            display: grid; 
            grid-template-columns: var(--col-line) 1fr var(--col-time);
            align-items: baseline;
            font-size: 5.5vh; 
            line-height: 1.3;
            border-bottom: 1px solid rgba(255, 176, 0, 0.15);
        }

        .line { color: var(--led-on); }
        .dest { 
            white-space: nowrap; overflow: hidden; position: relative; display: block; 
            margin-right: 20px;
        }
        .time { text-align: right; }

        /* Animationen */
        .marquee span { display: inline-block; padding-left: 0; animation: scroll 10s linear infinite; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        .pulse { animation: modernPulse 1.5s ease-in-out infinite; }
        @keyframes modernPulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* FULLSCREEN BUTTON */
        #fs-toggle {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(30,30,30,0.8); color: #fff;
            border: 1px solid #555; border-radius: 4px;
            padding: 8px 12px; font-family: 'Inter', sans-serif; font-size: 12px;
            cursor: pointer; z-index: 20000;
            opacity: 0; transition: opacity 0.5s;
        }
        #fs-toggle:hover { opacity: 1 !important; background: var(--led-on); color: black; }

    </style>
</head>
<body>

    <div class="matrix-overlay"></div>
    <div id="lamp-test"></div>

    <div id="setup-screen">
        <h2 style="font-weight:400; letter-spacing:4px; margin-bottom:40px;">DFI CONFIG</h2>
        
        <div class="input-group">
            <label>Stadt</label>
            <input type="text" id="city-input" placeholder="z.B. Koblenz" value="Koblenz">
        </div>
        <div class="input-group">
            <label>Haltestelle</label>
            <input type="text" id="stop-input" placeholder="z.B. Zentralplatz" value="Zentralplatz">
        </div>
        
        <button id="start-btn">ANZEIGE STARTEN</button>
        <div id="error-msg"></div>
    </div>

    <div id="display-screen">
        <div class="header">
            <div class="station-name" id="station-title">...</div>
            <div class="clock" id="main-clock">00:00</div>
        </div>
        
        <div class="labels">
            <span>Linie</span>
            <span>Ziel</span>
            <span>Abfahrt</span>
        </div>

        <div id="matrix-rows"></div>
    </div>

    <button id="fs-toggle" onclick="toggleFullscreen()">Vollbild</button>

<script>
    let stationID = null;
    let busData = [];
    let mouseTimer = null;

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(e => console.log(e));
        } else {
            document.exitFullscreen();
        }
    }

    document.addEventListener('mousemove', () => {
        const btn = document.getElementById('fs-toggle');
        btn.style.opacity = '1';
        clearTimeout(mouseTimer);
        mouseTimer = setTimeout(() => { btn.style.opacity = '0'; }, 3000);
    });

    document.getElementById('start-btn').onclick = async () => {
        const city = document.getElementById('city-input').value;
        const stop = document.getElementById('stop-input').value;
        const btn = document.getElementById('start-btn');
        const err = document.getElementById('error-msg');

        if(!city || !stop) {
            err.innerText = "Bitte beides ausfüllen.";
            return;
        }

        btn.innerText = "SUCHE STATION...";
        err.innerText = "";
        
        try {
            // FIX: Wir suchen jetzt explizit nur nach STOPS (poi=false, addresses=false)
            // Das verhindert, dass "Koblenz Zentralplatz" als Sehenswürdigkeit ohne Fahrplan gefunden wird.
            const query = encodeURIComponent(city + " " + stop);
            const res = await fetch(`https://v6.db.transport.rest/locations?query=${query}&results=5&poi=false&addresses=false`);
            const data = await res.json();
            
            // Debugging (falls du F12 drückst)
            console.log("Suchergebnisse:", data);

            if(!data || data.length === 0) {
                btn.innerText = "FEHLER";
                err.innerText = "Haltestelle nicht gefunden. Versuche es genauer (z.B. 'Zentralplatz Forum').";
                setTimeout(() => btn.innerText = "ANZEIGE STARTEN", 2000);
                return;
            }

            // Nimm den ersten Treffer
            stationID = data[0].id;
            let cleanName = data[0].name;
            
            // Versuche den Stadtnamen aus dem Haltestellennamen zu entfernen für die Optik
            // (RegEx Case Insensitive Replace)
            const cityRegex = new RegExp(city + "[, ]*", "gi");
            cleanName = cleanName.replace(cityRegex, "").trim();
            
            document.getElementById('station-title').innerText = cleanName;

            // Erfolgreich -> Boot
            document.getElementById('setup-screen').style.display = 'none';
            triggerBootSequence();

            if ('wakeLock' in navigator) {
                try { await navigator.wakeLock.request('screen'); } catch(e){}
            }

        } catch(e) {
            console.error(e);
            btn.innerText = "FEHLER";
            err.innerText = "Netzwerkfehler oder API down.";
            setTimeout(() => btn.innerText = "ANZEIGE STARTEN", 3000);
        }
    };

    function triggerBootSequence() {
        const testLayer = document.getElementById('lamp-test');
        testLayer.style.display = 'block';
        setTimeout(() => {
            testLayer.style.display = 'none';
            document.getElementById('display-screen').style.display = 'flex';
            startSystem();
        }, 1200);
    }

    function startSystem() {
        updateData();
        setInterval(updateData, 30000); 
        setInterval(renderClock, 1000);
        renderClock();
    }

    function renderClock() {
        const now = new Date();
        const str = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
        document.getElementById('main-clock').innerText = str;
        updateRelativeTimes(); 
    }

    async function updateData() {
        if(!stationID) return;
        try {
            // Daten abrufen
            const res = await fetch(`https://v6.db.transport.rest/stops/${stationID}/departures?results=15&duration=60`);
            const data = await res.json();
            
            if (!data.departures) return;

            const now = Date.now();
            
            busData = data.departures.map(dep => {
                const uniqueId = dep.tripId || (dep.line.name + dep.direction + dep.plannedWhen);
                const existing = busData.find(b => b.id === uniqueId);
                const planned = new Date(dep.plannedWhen).getTime();
                const actual = dep.when ? new Date(dep.when).getTime() : planned;
                
                return {
                    id: uniqueId,
                    line: dep.line.name,
                    dest: dep.direction,
                    time: actual,
                    cancelled: dep.cancelled || false,
                    sofortSince: existing ? existing.sofortSince : null
                };
            });

            busData = busData.filter(b => {
                const diff = b.time - now;
                if(diff <= 0) {
                    if(!b.sofortSince) b.sofortSince = now;
                    if(now - b.sofortSince > 30000) return false; 
                }
                return true;
            });
            
            busData.sort((a,b) => a.time - b.time);
            renderMatrix();

        } catch(e) { console.log("Update Error", e); }
    }

    function renderMatrix() {
        const container = document.getElementById('matrix-rows');
        container.innerHTML = '';

        const headerH = document.querySelector('.header').offsetHeight;
        const labelsH = document.querySelector('.labels').offsetHeight;
        const screenH = window.innerHeight;
        const available = screenH - headerH - labelsH - 40; 
        const rowHeight = window.innerHeight * 0.08; 
        
        const maxItems = Math.floor(available / rowHeight);
        const visibleData = busData.slice(0, maxItems);

        visibleData.forEach(bus => {
            const row = document.createElement('div');
            row.className = 'row';
            if(bus.cancelled) row.style.color = '#ff3333'; 

            let destHTML = `<span class="dest-text">${bus.dest}</span>`;
            if (bus.dest.length > 15) { 
                 destHTML = `<span class="marquee"><span>${bus.dest}&nbsp;&nbsp;&nbsp;&nbsp;${bus.dest}&nbsp;&nbsp;&nbsp;&nbsp;</span></span>`;
            }

            row.innerHTML = `
                <div class="line">${bus.line}</div>
                <div class="dest">${destHTML}</div>
                <div class="time" id="t-${bus.id}"></div>
            `;
            container.appendChild(row);
        });
        
        updateRelativeTimes();
    }

    function updateRelativeTimes() {
        const now = Date.now();
        busData.forEach(bus => {
            const el = document.getElementById(`t-${bus.id}`);
            if(!el) return;

            if(bus.cancelled) {
                el.innerText = "Entfällt";
                return;
            }

            const diffMin = Math.floor((bus.time - now) / 60000);

            if (diffMin <= 0) {
                el.innerHTML = 'sofort';
                el.className = 'time pulse'; 
            } else if (diffMin > 60) {
                const d = new Date(bus.time);
                el.innerText = String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
                el.className = 'time';
            } else {
                el.innerText = diffMin + ' min';
                el.className = 'time';
            }
        });
    }
    
    window.addEventListener('resize', () => { renderMatrix(); });

</script>
</body>
</html>
