<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFI Zentralplatz Pure</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght,ROND@800,100&family=Inter:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --led: #ffaa00;
            --bg: #000;
            /* Spaltenbreiten fest definieren gegen Überlappung */
            --col-line: 15vw;
            --col-time: 22vw;
        }

        body, html {
            margin: 0; padding: 0;
            background: var(--bg);
            color: var(--led);
            font-family: 'Doto', sans-serif;
            font-variation-settings: "ROND" 100;
            overflow: hidden;
            width: 100vw; height: 100vh;
        }

        #fs-icon {
            position: fixed; top: 10px; right: 10px; z-index: 100;
            color: #222; cursor: pointer; background: none; border: none;
        }
        :fullscreen #fs-icon { display: none; }

        .container {
            display: flex; flex-direction: column;
            height: 100vh; padding: 0 2vw;
        }

        .labels {
            display: grid;
            grid-template-columns: var(--col-line) 1fr var(--col-time);
            font-family: 'Inter', sans-serif;
            font-size: 2.5vh; color: #333;
            padding: 2vh 0 1vh 0; text-transform: uppercase;
            border-bottom: 2px solid #111;
        }
        .labels span:last-child { text-align: right; }

        /* Zeilen-System */
        .row {
            display: grid;
            grid-template-columns: var(--col-line) 1fr var(--col-time);
            align-items: center;
            height: 12vh;
            border-bottom: 1px solid #0a0a0a;
            font-size: 7vh;
        }

        .line-cell { font-weight: 900; overflow: hidden; }

        /* Fix für das Scrollen */
        .dest-cell {
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            display: flex;
        }

        .scroll-wrapper {
            display: inline-block;
            will-change: transform;
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .animate-scroll {
            animation: marquee 12s linear infinite;
        }

        .time-cell {
            text-align: right;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        .sofort {
            text-transform: lowercase;
            font-size: 0.85em;
            animation: blink 1s steps(2, start) infinite;
        }

        @keyframes blink { to { visibility: hidden; } }
    </style>
</head>
<body>

    <button id="fs-icon" onclick="document.documentElement.requestFullscreen()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
    </button>

    <div class="container">
        <div class="labels">
            <span>Linie</span>
            <span>Ziel</span>
            <span>Abfahrt</span>
        </div>
        <div id="matrix"></div>
    </div>

<script>
    const STATION_NAME = "Koblenz Zentralplatz Forum";
    let stationID = null;
    let busData = []; // Speichert Bus-Objekte inkl. "Sofort-Timer"

    async function init() {
        try {
            const res = await fetch(`https://v6.db.transport.rest/locations?query=${encodeURIComponent(STATION_NAME)}&results=1`);
            const data = await res.json();
            stationID = data[0].id;
            
            fetchUpdate();
            setInterval(fetchUpdate, 30000); // Neue Daten alle 30s
            setInterval(logicTick, 1000);    // Logik & Render jede Sekunde
        } catch (e) { console.error("API Error", e); }
    }

    async function fetchUpdate() {
        if(!stationID) return;
        try {
            const res = await fetch(`https://v6.db.transport.rest/stops/${stationID}/departures?results=10&duration=60`);
            const data = await res.json();
            
            // Abgleichen mit vorhandenen Bussen, um Timer zu behalten
            const newList = data.departures.map(dep => {
                const existing = busData.find(b => b.tripId === dep.tripId);
                return {
                    tripId: dep.tripId || (dep.line.name + dep.direction + dep.when),
                    line: dep.line.name,
                    dest: dep.direction,
                    time: new Date(dep.when || dep.plannedWhen),
                    sofortSince: existing ? existing.sofortSince : null
                };
            });
            busData = newList;
        } catch (e) { console.error("Update Error", e); }
    }

    function logicTick() {
        const now = new Date();
        
        // 1. Logik: Sofort-Timer prüfen und abgelaufene Busse markieren
        busData = busData.filter(bus => {
            const diffMin = Math.floor((bus.time - now) / 60000);
            
            if (diffMin <= 0) {
                if (!bus.sofortSince) {
                    bus.sofortSince = now.getTime(); // Jetzt fängt die "sofort" Zeit an
                }
                
                // Wenn mehr als 20 Sekunden vergangen sind seit "sofort", löschen
                const secondsPassed = (now.getTime() - bus.sofortSince) / 1000;
                if (secondsPassed > 20) return false; 
            }
            return true;
        });

        render();
    }

    function render() {
        const matrix = document.getElementById('matrix');
        const now = new Date();
        
        // Damit Animationen nicht springen, bauen wir das HTML nur bei Änderungen neu
        // Oder wir nutzen ein stabiles Render-System:
        let html = '';

        busData.slice(0, 7).forEach((bus, i) => {
            const diffMin = Math.floor((bus.time - now) / 60000);
            let timeStr = "";

            if (bus.sofortSince) {
                timeStr = '<span class="sofort">sofort</span>';
            } else if (diffMin < 20) {
                timeStr = diffMin + ' Min';
            } else {
                timeStr = bus.time.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'});
            }

            html += `
                <div class="row">
                    <div class="line-cell">${bus.line}</div>
                    <div class="dest-cell" id="dc-${i}">
                        <div class="scroll-wrapper" id="sw-${i}">${bus.dest}</div>
                    </div>
                    <div class="time-cell">${timeStr}</div>
                </div>
            `;
        });

        matrix.innerHTML = html;

        // Scroll-Animation triggern
        busData.slice(0, 7).forEach((bus, i) => {
            const wrapper = document.getElementById(`sw-${i}`);
            const cell = document.getElementById(`dc-${i}`);
            if (wrapper && cell && wrapper.offsetWidth > cell.offsetWidth) {
                // Text verdoppeln für nahtlosen Loop
                wrapper.innerHTML = `${bus.dest} &nbsp;&nbsp;&nbsp;&nbsp; ${bus.dest} &nbsp;&nbsp;&nbsp;&nbsp;`;
                wrapper.classList.add('animate-scroll');
            }
        });
    }

    init();
</script>
</body>
</html>
