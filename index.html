<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abfahrt Zentralplatz Koblenz</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght,ROND@800,100&family=Inter:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --case-color: #4a4d52; /* Dunkelgrau wie das Gehäuse */
            --led-color: #ffaa00;   /* Bernstein/Gelb wie auf dem Foto */
            --led-dim: #3a2a00;     /* Farbe für inaktive Pixel (Hintergrund) - optional */
            --bg-matrix: #1a1a1a;   /* Der schwarze Hintergrund der Anzeige */
        }

        body {
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }

        /* Das Gehäuse der Anzeige */
        .bus-display-case {
            background-color: var(--case-color);
            padding: 20px 30px 40px 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
        }

        /* Die statische Überschrift (Nicht Doto, wie gewünscht) */
        .station-name {
            color: #ccc;
            font-size: 2.2rem;
            font-weight: 500;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        /* Spaltenüberschriften */
        .labels {
            display: grid;
            grid-template-columns: 1.5fr 4fr 1.5fr; /* Rasterung */
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 5px;
            padding: 0 10px;
        }

        .labels span:last-child {
            text-align: right;
        }

        /* Der schwarze Bereich der LED Anzeige */
        .matrix-screen {
            background-color: var(--bg-matrix);
            padding: 15px;
            border-radius: 4px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            min-height: 200px;
        }

        /* Die eigentlichen Datenzeilen */
        .departure-row {
            display: grid;
            grid-template-columns: 1.5fr 4fr 1.5fr;
            margin-bottom: 8px;
            align-items: baseline;
        }

        /* Hier wird die Doto Schriftart angewendet */
        .led-text {
            font-family: 'Doto', sans-serif;
            font-weight: 800; /* Dicke Schrift */
            font-variation-settings: "ROND" 100; /* Macht die Pixel rund */
            color: var(--led-color);
            font-size: 1.6rem;
            line-height: 1.2;
            text-transform: uppercase;
            
            /* Leichter Leuchteffekt für Realismus */
            text-shadow: 0 0 4px rgba(255, 170, 0, 0.4);
        }

        .line-number {
            text-align: left;
        }

        .destination {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Pünktchen wenn zu lang */
            padding-right: 10px;
        }

        .time {
            text-align: right;
        }

        /* Animation beim Laden */
        .blink {
            animation: blinker 1s linear infinite;
        }

        @keyframes blinker {
            50% { opacity: 0; }
        }

        /* Kleiner Hinweis unten */
        .status-bar {
            margin-top: 10px;
            font-size: 0.7rem;
            color: #777;
            text-align: right;
        }
    </style>
</head>
<body>

    <div class="bus-display-case">
        <div class="station-name">Zentralplatz</div>
        
        <div class="labels">
            <span>Linie</span>
            <span>Ziel</span>
            <span>Abfahrt</span>
        </div>

        <div class="matrix-screen" id="board">
            <div class="departure-row led-text" style="justify-content: center;">
                <span class="blink">LADE DATEN...</span>
            </div>
        </div>

        <div class="status-bar" id="status">Verbinde mit Live-API...</div>
    </div>

    <script>
        // Station ID für Koblenz Zentralplatz/Forum (DB/VRM ID)
        // Sollte diese ID nicht stimmen, kann man sie über die API suchen
        const STATION_ID = '468263'; 

        async function fetchDepartures() {
            const board = document.getElementById('board');
            const status = document.getElementById('status');

            try {
                // Nutzung der offenen Transport API (Wrapper für DB Hafas)
                const response = await fetch(`https://v6.db.transport.rest/stops/${STATION_ID}/departures?results=6&duration=60`);
                
                if (!response.ok) throw new Error("API Fehler");

                const data = await response.json();
                const departures = data.departures;

                // Board leeren
                board.innerHTML = '';

                if (departures.length === 0) {
                    board.innerHTML = '<div class="departure-row led-text"><span>KEINE BUSSE</span></div>';
                    return;
                }

                // Durch die Ergebnisse loopen und Zeilen bauen
                departures.forEach(dep => {
                    // Zeit berechnen
                    const scheduledTime = new Date(dep.when || dep.plannedWhen);
                    const now = new Date();
                    const diffMs = scheduledTime - now;
                    const diffMins = Math.round(diffMs / 60000);

                    // Anzeige formatieren (Minuten oder Uhrzeit)
                    // Wie auf Bild 1: Wenn < 20 min, zeige Minuten, sonst Uhrzeit (oder gemischt)
                    // Das Foto zeigt "8 Min" und Uhrzeiten. Wir simulieren das:
                    
                    let timeDisplay;
                    if (diffMins <= 0) {
                        timeDisplay = "0 Min"; // Oder blinkend
                    } else if (diffMins < 10) {
                        timeDisplay = `${diffMins} Min`;
                    } else {
                        // Uhrzeit formatieren HH:MM
                        const hours = scheduledTime.getHours().toString().padStart(2, '0');
                        const minutes = scheduledTime.getMinutes().toString().padStart(2, '0');
                        timeDisplay = `${hours}:${minutes}`;
                    }

                    // Linie und Ziel bereinigen
                    const line = dep.line.name || '?';
                    let dest = dep.direction || 'Unbekannt';
                    
                    // Zu lange Ziele kürzen für bessere Optik
                    if (dest.length > 15) {
                        // Optional: Logik zum Kürzen
                    }

                    // HTML Zeile erstellen
                    const row = document.createElement('div');
                    row.className = 'departure-row led-text';
                    row.innerHTML = `
                        <span class="line-number">${line}</span>
                        <span class="destination">${dest}</span>
                        <span class="time">${timeDisplay}</span>
                    `;
                    board.appendChild(row);
                });

                status.innerText = 'Live aktualisiert: ' + new Date().toLocaleTimeString();

            } catch (error) {
                console.error(error);
                // Wenn es schiefgeht, behalte alte Daten oder zeige Fehler
                if(board.innerText.includes("LADE")) {
                    board.innerHTML = '<div class="departure-row led-text" style="color:red">FEHLER</div>';
                }
                status.innerText = 'Verbindungsfehler - versuche erneut...';
            }
        }

        // Initialer Aufruf
        fetchDepartures();

        // Alle 60 Sekunden aktualisieren
        setInterval(fetchDepartures, 60000);
    </script>
</body>
</html>
