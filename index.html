<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFI Live-Anzeige Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght,ROND@800,100&family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --led: #ffaa00;
            --bg: #000;
            /* Feste Spaltenbreiten für absolute Stabilität */
            --col-line: 140px; 
            --col-time: 200px;
        }

        body, html {
            margin: 0; padding: 0;
            background: var(--bg);
            color: var(--led);
            font-family: 'Doto', sans-serif;
            font-variation-settings: "ROND" 100;
            overflow: hidden;
            width: 100vw; height: 100vh;
        }

        /* SETUP SCREEN */
        #setup-screen {
            position: fixed; inset: 0;
            background: #111; z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            font-family: 'Inter', sans-serif; color: white;
        }

        .input-group { margin: 15px; width: 80%; max-width: 400px; }
        .input-group label { display: block; margin-bottom: 5px; color: #888; }
        .input-group input { 
            width: 100%; padding: 12px; background: #222; border: 1px solid #444;
            color: white; border-radius: 8px; font-size: 1.1rem;
        }

        #start-btn {
            padding: 12px 30px; background: var(--led); border: none;
            border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;
            margin-top: 20px;
        }

        /* DISPLAY SCREEN */
        #display-screen { display: none; flex-direction: column; height: 100vh; padding: 0 20px; }

        #fs-icon {
            position: fixed; top: 15px; right: 15px; z-index: 100;
            color: #333; cursor: pointer; opacity: 0.5;
        }
        :fullscreen #fs-icon { display: none; }

        .header-title {
            font-family: 'Inter', sans-serif; font-size: 40px;
            padding: 20px 0; color: #eee; font-weight: 700;
        }

        .labels {
            display: grid; grid-template-columns: var(--col-line) 1fr var(--col-time);
            font-family: 'Inter', sans-serif; font-size: 18px; color: #444;
            padding-bottom: 10px; text-transform: uppercase; border-bottom: 2px solid #111;
        }
        .labels span:last-child { text-align: right; }

        .row {
            display: grid; grid-template-columns: var(--col-line) 1fr var(--col-time);
            align-items: center; height: 12vh; border-bottom: 1px solid #0a0a0a;
            font-size: 6.5vh;
        }

        .line-cell { font-weight: 900; }

        /* SCROLL LOGIK */
        .dest-cell { 
            overflow: hidden; 
            white-space: nowrap; 
            display: flex; 
            position: relative;
            margin-right: 20px;
        }

        .marquee-content {
            display: inline-block;
            will-change: transform;
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .animate-scroll {
            animation: marquee 12s linear infinite;
        }

        .time-cell { text-align: right; font-variant-numeric: tabular-nums; white-space: nowrap; }

        .sofort {
            text-transform: lowercase; font-size: 0.9em;
            animation: blink 1s steps(2, start) infinite;
        }
        @keyframes blink { to { visibility: hidden; } }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1 style="margin-bottom: 30px;">Haltestellen-Konfiguration</h1>
        <div class="input-group">
            <label>Stadt</label>
            <input type="text" id="city-input" placeholder="z.B. Koblenz">
        </div>
        <div class="input-group">
            <label>Haltestelle</label>
            <input type="text" id="stop-input" placeholder="z.B. Zentralplatz">
        </div>
        <button id="start-btn">Anzeige starten</button>
    </div>

    <div id="display-screen">
        <div id="fs-icon" onclick="document.documentElement.requestFullscreen()">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
        </div>
        <div class="header-title" id="station-title">Lade...</div>
        <div class="labels">
            <span>Linie</span>
            <span>Ziel</span>
            <span>Abfahrt</span>
        </div>
        <div id="matrix"></div>
    </div>

<script>
    let stationID = null;
    let busData = [];
    const MAX_ROWS = 7;

    document.getElementById('start-btn').onclick = async () => {
        const city = document.getElementById('city-input').value;
        const stop = document.getElementById('stop-input').value;
        if(!city || !stop) return;

        try {
            const res = await fetch(`https://v6.db.transport.rest/locations?query=${encodeURIComponent(city + " " + stop)}&results=1`);
            const data = await res.json();
            if(!data[0]) return alert("Nicht gefunden!");
            
            stationID = data[0].id;
            document.getElementById('station-title').innerText = data[0].name;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('display-screen').style.display = 'flex';
            
            startTicker();
        } catch(e) { alert("Fehler!"); }
    };

    function startTicker() {
        updateAPI();
        setInterval(updateAPI, 30000); // Alle 30s Daten holen
        setInterval(logicTick, 1000);  // Jede Sekunde Logik prüfen
    }

    async function updateAPI() {
        try {
            const res = await fetch(`https://v6.db.transport.rest/stops/${stationID}/departures?results=15&duration=60`);
            const data = await res.json();
            
            const now = Date.now();
            busData = data.departures.map(dep => {
                const existing = busData.find(b => b.tripId === dep.tripId);
                return {
                    tripId: dep.tripId || (dep.line.name + dep.direction + dep.when),
                    line: dep.line.name,
                    dest: dep.direction,
                    time: new Date(dep.when || dep.plannedWhen),
                    sofortSince: existing ? existing.sofortSince : null
                };
            });
            renderRows();
        } catch(e) {}
    }

    function logicTick() {
        const now = Date.now();
        let changed = false;

        busData = busData.filter(bus => {
            const diff = bus.time - now;
            if (diff <= 0) {
                if (!bus.sofortSince) bus.sofortSince = now;
                // Wenn mehr als 20 Sek auf "sofort", dann löschen
                if ((now - bus.sofortSince) > 20000) {
                    changed = true;
                    return false;
                }
            }
            return true;
        });

        if (changed) renderRows();
        updateTimesOnly();
    }

    function renderRows() {
        const matrix = document.getElementById('matrix');
        const displayList = busData.slice(0, MAX_ROWS);
        
        // Verhindert Flackern: Nur neu bauen, wenn sich die Busse ändern
        const currentIds = displayList.map(b => b.tripId).join('|');
        if (matrix.dataset.lastIds === currentIds) return;
        matrix.dataset.lastIds = currentIds;

        matrix.innerHTML = '';
        displayList.forEach((bus, i) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `
                <div class="line-cell">${bus.line}</div>
                <div class="dest-cell" id="cell-${i}">
                    <span class="marquee-content" id="text-${i}">${bus.dest}</span>
                </div>
                <div class="time-cell" id="time-${i}">--:--</div>
            `;
            matrix.appendChild(row);

            // PRÜFUNG: Muss es scrollen?
            const container = document.getElementById(`cell-${i}`);
            const text = document.getElementById(`text-${i}`);
            
            // Kleiner Timeout damit der Browser die Breite berechnen kann
            setTimeout(() => {
                if (text.offsetWidth > container.offsetWidth) {
                    // Text ist zu lang -> Scrollen aktivieren
                    text.innerHTML = `${bus.dest} &nbsp;&nbsp;&nbsp;&nbsp; ${bus.dest} &nbsp;&nbsp;&nbsp;&nbsp;`;
                    text.classList.add('animate-scroll');
                } else {
                    // Text passt -> Kein Scrollen
                    text.classList.remove('animate-scroll');
                }
            }, 50);
        });
    }

    function updateTimesOnly() {
        const now = Date.now();
        busData.slice(0, MAX_ROWS).forEach((bus, i) => {
            const el = document.getElementById(`time-${i}`);
            if(!el) return;

            const diffMin = Math.floor((bus.time - now) / 60000);
            let html = "";

            if(bus.sofortSince) {
                html = '<span class="sofort">sofort</span>';
            } else if(diffMin < 20) {
                html = diffMin + " Min";
            } else {
                html = bus.time.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
            }

            if(el.innerHTML !== html) el.innerHTML = html;
        });
    }
</script>
</body>
</html>
