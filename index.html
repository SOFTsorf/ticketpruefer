<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StatusAnzeige für Bus&Bahn koveb|VRM</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght,ROND@900,100&family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --led: #ffaa00;     /* Standard Orange */
            --led-red: #ff3333; /* Alarm/Ausfall Rot */
            --bg: #000;
            --col-line: 20vw; 
            --col-time: 25vw;
        }

        body, html {
            margin: 0; padding: 0;
            background: var(--bg);
            color: var(--led);
            font-family: 'Doto', sans-serif;
            font-variation-settings: "ROND" 100;
            overflow: hidden;
            width: 100vw; height: 100vh;
        }

        /* SETUP SCREEN */
        #setup-screen {
            position: fixed; inset: 0; background: #111; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Inter', sans-serif; color: white;
        }
        .input-group { margin: 15px; width: 80%; max-width: 400px; }
        .input-group input { 
            width: 100%; padding: 12px; background: #222; border: 1px solid #444;
            color: white; border-radius: 8px; font-size: 1.1rem; box-sizing: border-box;
        }
        #start-btn { padding: 12px 30px; background: var(--led); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: black; }

        /* MAIN DISPLAY */
        #display-screen { 
            display: none; flex-direction: column; height: 100vh; width: 100vw; 
            box-sizing: border-box; padding: 0 3vw;
        }

        #fs-icon { 
            position: fixed; top: 15px; right: 15px; z-index: 100; 
            color: #333; cursor: pointer; opacity: 0.6;
            background: rgba(255,255,255,0.05); padding: 5px; border-radius: 5px;
        }

        /* KOPFZEILE */
        .header-area { flex: 0 0 auto; padding: 2vh 0 1vh 0; }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5vh;
        }

        .station-name { 
            font-family: 'Inter', sans-serif; 
            font-size: clamp(26px, 5.5vh, 55px); 
            color: #eee; font-weight: 700; margin: 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            flex: 1;
        }

        /* UHR IN PIXEL-OPTIK */
        #current-time {
            font-family: 'Doto', sans-serif;
            font-variation-settings: "ROND" 100;
            font-size: clamp(24px, 5vh, 50px);
            color: var(--led); /* Gleiche Farbe wie die Abfahrten */
            font-weight: 900;
            margin-left: 20px;
            letter-spacing: 2px;
        }
        
        .labels {
            display: grid; grid-template-columns: var(--col-line) 1fr var(--col-time);
            font-family: 'Inter', sans-serif; 
            font-size: clamp(16px, 2.8vh, 30px); 
            color: #666;
            text-transform: uppercase; border-bottom: 2px solid #111; padding-bottom: 0.8vh;
        }
        .labels span:last-child { text-align: right; }

        /* MATRIX */
        #matrix { flex: 1 1 auto; display: flex; flex-direction: column; overflow: hidden; }

        .row {
            flex: 1; display: grid; grid-template-columns: var(--col-line) 1fr var(--col-time);
            align-items: center; border-bottom: 1px solid #0a0a0a;
            font-size: 6vh; min-height: 0; 
            position: relative;
        }

        .line-cell { font-weight: 900; white-space: nowrap; overflow: hidden; padding-right: 15px; }
        .dest-cell { overflow: hidden; white-space: nowrap; display: flex; position: relative; margin-right: 15px; }
        .marquee-content { display: inline-block; will-change: transform; }
        
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .animate-scroll { animation: marquee 14s linear infinite; }

        /* ZEIT & STATUS STYLES */
        .time-cell { 
            text-align: right; font-variant-numeric: tabular-nums; 
            display: flex; flex-direction: column; justify-content: center; align-items: flex-end;
        }
        
        .sofort { text-transform: lowercase; font-size: 0.85em; animation: blink 1s steps(2, start) infinite; }
        
        /* Styles für Ausfälle */
        .row.cancelled { color: var(--led-red); }
        .row.cancelled .dest-cell { text-decoration: line-through; opacity: 0.7; }
        .cancelled-msg { font-size: 0.6em; text-transform: uppercase; animation: blink-red 2s infinite; }

        /* Styles für Verspätung */
        .delay-info { 
            font-size: 0.35em; font-family: 'Inter', sans-serif; font-weight: bold;
            color: var(--led-red); margin-bottom: -5px; display: block;
        }

        @keyframes blink { to { visibility: hidden; } }
        @keyframes blink-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    </style>
</head>
<body>

    <div id="setup-screen">
        <h2 style="margin-bottom: 20px;">DFI Simulator Pro</h2>
        <div class="input-group"><input type="text" id="city-input" placeholder="Stadt"></div>
        <div class="input-group"><input type="text" id="stop-input" placeholder="Haltestelle"></div>
        <button id="start-btn">Anzeige starten</button>
    </div>

    <div id="display-screen">
        <div id="fs-icon" onclick="toggleFullscreen()">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
        </div>
        <div class="header-area">
            <div class="header-top">
                <p class="station-name" id="station-title">Lade...</p>
                <div id="current-time">00:00</div>
            </div>
            <div class="labels"><span>Linie</span><span>Ziel</span><span>Abfahrt</span></div>
        </div>
        <div id="matrix"></div>
    </div>

<script>
    let stationID = null;
    let busData = [];
    let wakeLock = null;

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => alert(err.message));
        } else {
            document.exitFullscreen();
        }
    }

    document.addEventListener('fullscreenchange', () => {
        const btn = document.getElementById('fs-icon');
        btn.style.display = document.fullscreenElement ? 'none' : 'block';
        renderFrame();
    });

    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }

    document.getElementById('start-btn').onclick = async () => {
        const city = document.getElementById('city-input').value;
        const stop = document.getElementById('stop-input').value;
        const query = `${city} ${stop}`;
        try {
            const res = await fetch(`https://v6.db.transport.rest/locations?query=${encodeURIComponent(query)}&results=1`);
            const data = await res.json();
            if(!data[0]) return alert("Haltestelle nicht gefunden!");
            
            stationID = data[0].id;
            document.getElementById('station-title').innerText = data[0].name;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('display-screen').style.display = 'flex';
            
            requestWakeLock();
            startEngine();
        } catch(e) { alert("Verbindungsfehler!"); }
    };

    function startEngine() {
        updateData();
        updateHeaderClock();
        setInterval(updateData, 30000);
        setInterval(processLogic, 1000);
        setInterval(updateHeaderClock, 1000);
        window.addEventListener('resize', renderFrame);
    }

    function updateHeaderClock() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        const clockEl = document.getElementById('current-time');
        if (clockEl && clockEl.innerText !== timeStr) {
            clockEl.innerText = timeStr;
        }
    }

    function sortData() {
        const now = Date.now();
        busData.sort((a, b) => {
            const aIsSofort = !a.cancelled && (a.sofortSince || (a.time - now <= 0));
            const bIsSofort = !b.cancelled && (b.sofortSince || (b.time - now <= 0));

            if (aIsSofort && !bIsSofort) return -1; 
            if (!aIsSofort && bIsSofort) return 1;
            
            return a.time - b.time;
        });
    }

    async function updateData() {
        if(!stationID) return;
        try {
            const res = await fetch(`https://v6.db.transport.rest/stops/${stationID}/departures?results=20&duration=60&remarks=true`);
            const data = await res.json();
            
            busData = data.departures.map(dep => {
                const existing = busData.find(b => b.tripId === dep.tripId);
                
                let hints = "";
                if(dep.remarks && dep.remarks.length > 0) {
                    const txt = dep.remarks.filter(r => r.type === 'status' || r.type === 'warning').map(r => r.text).join(' +++ ');
                    if(txt) hints = " +++ " + txt;
                }

                const delaySec = dep.delay || 0;

                return {
                    tripId: dep.tripId || (dep.line.name + dep.direction + dep.when),
                    line: dep.line.name,
                    dest: dep.direction + hints, 
                    time: new Date(dep.when || dep.plannedWhen),
                    cancelled: dep.cancelled || false, 
                    delay: delaySec,
                    sofortSince: existing ? existing.sofortSince : null
                };
            });
            
            sortData();
            renderFrame();
        } catch(e) {}
    }

    function processLogic() {
        const now = Date.now();
        
        busData = busData.filter(bus => {
            const timeDiff = bus.time - now;
            
            if (timeDiff <= 0) {
                if (bus.cancelled) {
                    return timeDiff > -60000; 
                } else {
                    if (!bus.sofortSince) bus.sofortSince = now;
                    return (now - bus.sofortSince) <= 20000;
                }
            }
            return true;
        });

        sortData();
        renderFrame();
        updateClocks();
    }

    function renderFrame() {
        const container = document.getElementById('matrix');
        const headerArea = document.querySelector('.header-area');
        if(!container || !headerArea) return;

        const availableHeight = window.innerHeight - headerArea.offsetHeight - 20;
        const rowHeightTarget = window.innerHeight * 0.12; 
        const maxRows = Math.floor(availableHeight / rowHeightTarget);
        
        const list = busData.slice(0, Math.max(1, maxRows));
        
        if (list.length === 0 && stationID) {
            if (container.dataset.ids === "none") return;
            container.dataset.ids = "none";
            container.innerHTML = `
                <div class="row">
                    <div class="line-cell"></div>
                    <div class="dest-cell">Keine Fahrten mehr für heute.</div>
                    <div class="time-cell"></div>
                </div>
            `;
            return;
        }

        const ids = list.map(b => b.tripId + b.cancelled + b.delay).join('|') + maxRows;
        
        if (container.dataset.ids === ids) return;
        container.dataset.ids = ids;

        container.innerHTML = '';
        list.forEach((bus, i) => {
            const row = document.createElement('div');
            row.className = `row ${bus.cancelled ? 'cancelled' : ''}`;
            
            row.innerHTML = `
                <div class="line-cell">${bus.line}</div>
                <div class="dest-cell" id="c-${i}"><span class="marquee-content" id="m-${i}">${bus.dest}</span></div>
                <div class="time-cell" id="t-${i}">--</div>
            `;
            container.appendChild(row);
            
            setTimeout(() => {
                const m = document.getElementById(`m-${i}`);
                const c = document.getElementById(`c-${i}`);
                if (m && c && m.offsetWidth > c.offsetWidth) {
                    m.innerHTML = `${bus.dest} &nbsp;&nbsp;&nbsp;&nbsp; ${bus.dest} &nbsp;&nbsp;&nbsp;&nbsp;`;
                    m.classList.add('animate-scroll');
                }
            }, 100);
        });
        updateClocks();
    }

    function updateClocks() {
        const now = Date.now();
        const rows = document.querySelectorAll('.time-cell');
        if (busData.length === 0) return;
        
        busData.slice(0, rows.length).forEach((bus, i) => {
            const el = document.getElementById(`t-${i}`);
            if(!el) return;

            let html = '';

            if (bus.cancelled) {
                html = '<span class="cancelled-msg">Entfällt</span>';
            } else {
                const diffMin = Math.floor((bus.time - now) / 60000);
                const isSofort = (bus.sofortSince || diffMin <= 0);

                if (isSofort) {
                    html = '<span class="sofort">sofort</span>';
                } else {
                    let delayHtml = '';
                    if (bus.delay > 60) {
                        const delayMin = Math.floor(bus.delay / 60);
                        delayHtml = `<span class="delay-info">+ ${delayMin}</span>`;
                    } else if (bus.delay < -60) {
                         delayHtml = `<span class="delay-info">${Math.ceil(bus.delay/60)}</span>`;
                    }

                    if (diffMin < 20) {
                        html = `${delayHtml}${diffMin} Min`;
                    } else {
                        const timeStr = bus.time.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
                        html = `${delayHtml}${timeStr}`;
                    }
                }
            }
            
            if(el.innerHTML !== html) el.innerHTML = html;
        });
    }
</script>
</body>
</html>
