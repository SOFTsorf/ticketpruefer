<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBIS-IP Ticket Validator</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    
    <style>
        :root {
            --vrm-blue: #005293;
            --success-green: #28a745;
            --error-red: #dc3545;
        }
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: #e9ecef;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        header {
            background-color: var(--vrm-blue);
            color: white;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .container {
            width: 95%;
            max-width: 500px;
            margin-top: 20px;
        }
        #reader {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: none !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .status-icon {
            font-size: 50px;
            margin-bottom: 10px;
        }
        .valid { border-left: 8px solid var(--success-green); }
        .invalid { border-left: 8px solid var(--error-red); }
        
        .ticket-info {
            text-align: left;
            margin-top: 15px;
            font-size: 14px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }
        .raw-data {
            font-family: monospace;
            font-size: 10px;
            color: #666;
            word-break: break-all;
            margin-top: 10px;
        }
        button {
            background: var(--vrm-blue);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<header>
    <h1>D-Ticket Prüfer</h1>
    <small>IBIS-IP TicketValidationService v2.4</small>
</header>

<div class="container">
    <div id="reader"></div>
    
    <div id="resultCard" class="result-card">
        <div id="statusIcon" class="status-icon"></div>
        <h2 id="statusText"></h2>
        <div id="ticketDetails" class="ticket-info"></div>
        <div class="raw-data" id="rawData"></div>
        <button onclick="resetScanner()">Nächster Scan</button>
    </div>

    <div style="margin-top: 15px;">
        <button id="nfcBtn">NFC Scan (Nur Android/Chrome)</button>
    </div>
</div>

<script>
    // Konfiguration gemäß IBIS-IP_TicketValidationService_V2.4.xsd
    const html5QrCode = new Html5Qrcode("reader");
    const resultCard = document.getElementById('resultCard');
    const statusText = document.getElementById('statusText');
    const statusIcon = document.getElementById('statusIcon');
    const ticketDetails = document.getElementById('ticketDetails');
    const rawData = document.getElementById('rawData');

    const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

    async function startScanner() {
        html5QrCode.start(
            { facingMode: "environment" }, 
            qrConfig,
            onScanSuccess
        );
    }

    function onScanSuccess(decodedText) {
        // Scanner pausieren
        html5QrCode.pause(true);
        
        // Simuliere IBIS-IP TicketValidation Logik
        processValidation(decodedText);
    }

    function processValidation(data) {
        resultCard.style.display = "block";
        rawData.innerText = "Raw: " + data.substring(0, 100) + "...";

        // Logik basierend auf VDV-Standards
        let isVDV = data.includes("#UT01") || data.includes("#OT01");
        
        if (isVDV) {
            showResult(true, "GÜLTIG", {
                "Typ": "Deutschlandticket (VDV-KA)",
                "Klasse": "2. Klasse",
                "Inhaber": "Ermittelt aus Barcode...",
                "Prüfung": "Signatur ok (Simuliert)"
            });
        } else {
            showResult(false, "UNGÜLTIG", {
                "Fehler": "Kein gültiger VDV-Barcode erkannt.",
                "Info": "Bitte Aztec-Code scannen."
            });
        }
    }

    function showResult(isValid, text, details) {
        resultCard.className = "result-card " + (isValid ? "valid" : "invalid");
        statusIcon.innerText = isValid ? "✅" : "❌";
        statusText.innerText = text;
        statusText.style.color = isValid ? "var(--success-green)" : "var(--error-red)";
        
        let html = "";
        for (let key in details) {
            html += `<strong>${key}:</strong> ${details[key]}<br>`;
        }
        ticketDetails.innerHTML = html;
    }

    function resetScanner() {
        resultCard.style.display = "none";
        html5QrCode.resume();
    }

    // NFC Fallback Logik
    document.getElementById('nfcBtn').addEventListener('click', async () => {
        if ('NDEFReader' in window) {
            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                alert("NFC aktiv. Karte anhalten!");
                ndef.onreading = event => {
                    processValidation("NFC_CHIP_DATA_" + event.serialNumber);
                };
            } catch (error) {
                alert("NFC Fehler: " + error);
            }
        } else {
            alert("Web NFC wird nicht unterstützt (iPhone/Safari blockiert dies).");
        }
    });

    // Start
    startScanner();
</script>

</body>
</html>
